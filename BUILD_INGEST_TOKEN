name: App Forge CI
on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  workflow_dispatch:
    inputs:
      build_id:
        description: "App Forge Build ID (from App Forge UI)"
        required: true
        type: string
jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target: [apk, web]
    env:
      BUILD_ID: ${{ github.event.inputs.build_id || vars.REPO_VAR_BUILD_ID }}
    steps:
      - uses: actions/checkout@v4

      # Build steps here to produce path/to/output

      - name: Validate Build ID
        run: |
          if [ -z "${BUILD_ID}" ]; then
            echo "BUILD_ID is required. Provide via dispatch input or define REPO_VAR_BUILD_ID repo variable." >&2
            exit 1
          fi

      - name: Upload artifact to App Forge
        if: success()
        run: |
          curl -sS -X POST https://riff.new/_projects/brittle-warm-bridge-jr0j/dbtn/devx/app/routes/ci/ingest/${BUILD_ID}             -H "X-Filename: MyApp-1.0.0.${{ matrix.target == 'apk' && 'apk' || 'zip' }}"             -H "X-Content-Type: ${{ matrix.target == 'apk' && 'application/vnd.android.package-archive' || 'application/zip' }}"             -H "X-Build-Token: ${{ secrets.BUILD_INGEST_TOKEN }}"             --data-binary @path/to/output

      - name: Update success status
        if: success()
        run: |
          curl -sS -X POST https://riff.new/_projects/brittle-warm-bridge-jr0j/dbtn/devx/app/routes/ci/update/${BUILD_ID}             -H 'Content-Type: application/json'             -H "X-Build-Token: ${{ secrets.BUILD_INGEST_TOKEN }}"             -d '{"status":"success","progress":100}'

      - name: Update failed status
        if: failure()
        run: |
          curl -sS -X POST https://riff.new/_projects/brittle-warm-bridge-jr0j/dbtn/devx/app/routes/ci/update/${BUILD_ID}             -H 'Content-Type: application/json'             -H "X-Build-Token: ${{ secrets.BUILD_INGEST_TOKEN }}"             -d '{"status":"failed","progress":0,"logs":["failed on github actions"]}'
