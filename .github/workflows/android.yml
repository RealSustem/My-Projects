name: App Forge CI

on:
  push:
    branches: ["main"]
    tags: ["v*"]
  workflow_dispatch:
    inputs:
      build_id:
        description: "App Forge Build ID (from App Forge UI)"
        required: true
        type: string

env:
  BUILD_ID: ${{ github.event.inputs.build_id || vars.REPO_VAR_BUILD_ID }}
  API: https://riff.new/_projects/brittle-warm-bridge-jr0j/dbtn/devx/app/routes

# -------------------------------
# APK job
# -------------------------------
jobs:
  build_apk:
    runs-on: ubuntu-latest
    env:
      TARGET: apk
      TOKEN: ${{ secrets.BUILD_INGEST_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          packages: "platform-tools,platforms;android-34,build-tools;34.0.0"
          accept-android-sdk-licenses: true

      - name: Cache Gradle
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties') }}

      - name: Build APK
        shell: bash
        run: |
          set -euo pipefail
          shopt -s globstar
          GRADLEW=""
          if [ -f gradlew ]; then GRADLEW=./gradlew
          elif ls -1 **/gradlew 2>/dev/null | grep -q .; then GRADLEW=$(ls -1 **/gradlew 2>/dev/null | head -n1)
          fi
          if [ -z "$GRADLEW" ]; then
            echo "gradlew not found; skipping APK build"
          else
            chmod +x "$GRADLEW"
            "$GRADLEW" assembleRelease
          fi

      - name: Ingest APK
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${TOKEN:-}" ]; then
            echo "BUILD_INGEST_TOKEN missing; skipping APK upload"
            exit 0
          fi
          APK=$(ls -1 **/build/outputs/apk/*release*/**/*.apk **/build/outputs/apk/release/*.apk 2>/dev/null | head -n1)
          if [ -z "$APK" ]; then
            echo "APK not found; skipping upload"
          else
            echo "Uploading APK: $APK"
            HTTP_CODE=$(curl -sS -w "%{http_code}" -o /dev/null -X POST "$API/ci/ingest/$BUILD_ID" \
              -H "X-Filename: $(basename "$APK")" \
              -H "X-Content-Type: application/vnd.android.package-archive" \
              -H "X-Build-Token: $TOKEN" \
              --data-binary @"$APK")
            echo "Upload finished, HTTP code: $HTTP_CODE"
          fi

# -------------------------------
# AAB job
# -------------------------------
  build_aab:
    runs-on: ubuntu-latest
    env:
      TARGET: aab
      TOKEN: ${{ secrets.BUILD_INGEST_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          packages: "platform-tools,platforms;android-34,build-tools;34.0.0"
          accept-android-sdk-licenses: true

      - name: Cache Gradle
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties') }}

      - name: Build AAB
        shell: bash
        run: |
          set -euo pipefail
          shopt -s globstar
          GRADLEW=""
          if [ -f gradlew ]; then GRADLEW=./gradlew
          elif ls -1 **/gradlew 2>/dev/null | grep -q .; then GRADLEW=$(ls -1 **/gradlew 2>/dev/null | head -n1)
          fi
          if [ -z "$GRADLEW" ]; then
            echo "gradlew not found; skipping AAB build"
          else
            chmod +x "$GRADLEW"
            "$GRADLEW" bundleRelease
          fi

      - name: Ingest AAB
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${TOKEN:-}" ]; then
            echo "BUILD_INGEST_TOKEN missing; skipping AAB upload"
            exit 0
          fi
          AAB=$(ls -1 **/build/outputs/bundle/*[Rr]elease*/**/*.aab **/build/outputs/bundle/release/*.aab 2>/dev/null | head -n1)
          if [ -z "$AAB" ]; then
            echo "AAB not found; skipping upload"
          else
            echo "Uploading AAB: $AAB"
            HTTP_CODE=$(curl -sS -w "%{http_code}" -o /dev/null -X POST "$API/ci/ingest/$BUILD_ID" \
              -H "X-Filename: $(basename "$AAB")" \
              -H "X-Content-Type: application/octet-stream" \
              -H "X-Build-Token: $TOKEN" \
              --data-binary @"$AAB")
            echo "Upload finished, HTTP code: $HTTP_CODE"
          fi

# -------------------------------
# Web job
# -------------------------------
  build_web:
    runs-on: ubuntu-latest
    env:
      TARGET: web
      TOKEN: ${{ secrets.BUILD_INGEST_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Cache npm
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: npm-${{ hashFiles('**/package-lock.json') }}

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          if [ -f package.json ]; then
            npm ci
          elif [ -f frontend/package.json ]; then
            (cd frontend && npm ci)
          else
            echo "No package.json found; skipping npm install"

      - name: Build Web
        shell: bash
        run: |
          set -euo pipefail
          if [ -f package.json ]; then
            npm run build
          elif [ -f frontend/package.json ]; then
            (cd frontend && npm run build)
          else
            echo "No package.json found; skipping web build"

      - name: Ingest Web
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${TOKEN:-}" ]; then
            echo "BUILD_INGEST_TOKEN missing; skipping web upload"
            exit 0
          fi
          ZIP=web.zip
          if [ -d dist ]; then zip -r "$ZIP" dist >/dev/null
          elif [ -d build ]; then zip -r "$ZIP" build >/dev/null
          elif [ -d www ]; then zip -r "$ZIP" www >/dev/null
          else zip -r "$ZIP" . >/dev/null
          fi
          echo "Uploading Web ZIP: $ZIP"
          HTTP_CODE=$(curl -sS -w "%{http_code}" -o /dev/null -X POST "$API/ci/ingest/$BUILD_ID" \
            -H "X-Filename: $ZIP" \
            -H "X-Content-Type: application/zip" \
            -H "X-Build-Token: $TOKEN" \
            --data-binary @"$ZIP")
          echo "Upload finished, HTTP code: $HTTP_CODE"
