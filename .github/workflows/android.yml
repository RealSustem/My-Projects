#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
generator_single.py
–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ YAML –∏–ª–∏ AI.
–°–æ–∑–¥–∞—ë—Ç UI, backend, –∏ —Å–±–æ—Ä–∫–∏ web/apk/aab/exe/iso.
"""

import os, sys, subprocess, datetime, yaml, shutil, textwrap

# === CONFIG ===
OPENAI_KEYS = [
    os.getenv("OPENAI_KEY_1"),
    os.getenv("OPENAI_KEY_2"),
    os.getenv("OPENAI_KEY_3"),
    os.getenv("OPENAI_KEY_4"),
    os.getenv("OPENAI_KEY_5"),
]
DEFAULT_BUILD = ["web"]
OUT_DIR = "dist"


# === –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ===
def week_index():
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–æ–º–µ—Ä –Ω–µ–¥–µ–ª–∏ –∏ –≤—ã–±–∏—Ä–∞–µ—Ç –∏–Ω–¥–µ–∫—Å –∫–ª—é—á–∞."""
    week = datetime.date.today().isocalendar()[1]
    return (week - 1) % 5  # 0..4


def run(cmd, cwd=None, check=True):
    """–í—ã–ø–æ–ª–Ω—è–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—É—é –∫–æ–º–∞–Ω–¥—É."""
    print(f"\n$ {cmd}")
    res = subprocess.run(cmd, shell=True, cwd=cwd)
    if check and res.returncode != 0:
        sys.exit(res.returncode)


def ensure_dir(path):
    os.makedirs(path, exist_ok=True)


def install_system_deps():
    print("=== Installing system deps ===")
    pkgs = ["nodejs", "npm", "python3-pip", "genisoimage"]
    try:
        run("sudo apt-get update -y && sudo apt-get install -y " + " ".join(pkgs), check=False)
    except Exception as e:
        print(f"Apt skipped: {e}")


def install_pip_deps():
    print("=== Installing pip deps ===")
    run("python3 -m pip install --upgrade pip pyyaml jinja2 openai pyinstaller", check=False)


def install_flutter():
    print("=== Installing Flutter ===")
    if not shutil.which("flutter"):
        run("git clone https://github.com/flutter/flutter.git -b stable ~/flutter", check=False)
        os.environ["PATH"] += os.pathsep + os.path.expanduser("~/flutter/bin")


# === AI –≥–µ–Ω–µ—Ä–∞—Ü–∏—è YAML ===
def ai_generate_yaml(api_key):
    import openai
    openai.api_key = api_key
    prompt = textwrap.dedent("""
    –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π YAML-–æ–ø–∏—Å–∞–Ω–∏–µ –∫—Ä–æ—Å—Å–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:
    - –ò–º—è
    - –û–ø–∏—Å–∞–Ω–∏–µ
    - –°—Ç—Ä–∞–Ω–∏—Ü—ã UI (–º–∏–Ω–∏–º—É–º 2)
    - –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (–∫–Ω–æ–ø–∫–∏, –ø–æ–ª—è –≤–≤–æ–¥–∞, —Å–ø–∏—Å–∫–∏)
    - Backend endpoints (GET, POST)
    """).strip()

    print("=== Generating YAML via AI ===")
    completion = openai.ChatCompletion.create(
        model="gpt-4o-mini",
        messages=[{"role": "user", "content": prompt}],
    )
    text = completion.choices[0].message.content
    with open("app.yaml", "w") as f:
        f.write(text)
    print("‚úÖ app.yaml generated via AI")


# === –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ===
def build_from_yaml(path="app.yaml", out_dir=OUT_DIR, targets=None):
    ensure_dir(out_dir)
    with open(path, "r") as f:
        app = yaml.safe_load(f)

    app_name = app.get("name", "GeneratedApp")
    app_desc = app.get("description", "AI-generated application")

    # --- FRONTEND ---
    frontend = os.path.join(out_dir, "frontend")
    ensure_dir(frontend)
    index_html = f"""<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{app_name}</title>
  <style>
    body {{
      font-family: sans-serif;
      background: linear-gradient(135deg, #e0f7fa, #fff);
      text-align: center;
      padding: 3rem;
    }}
    h1 {{ color: #00796b; }}
    button {{
      background: #00796b; color: white; border: none;
      padding: 1em 2em; border-radius: 8px; cursor: pointer;
    }}
  </style>
</head>
<body>
  <h1>{app_name}</h1>
  <p>{app_desc}</p>
  <button onclick="alert('Hello from {app_name}!')">Click me</button>
</body>
</html>
"""
    with open(os.path.join(frontend, "index.html"), "w") as f:
        f.write(index_html)
    print("‚úÖ Frontend generated")

    # --- BACKEND ---
    backend = os.path.join(out_dir, "backend")
    ensure_dir(backend)
    app_py = textwrap.dedent(f"""
    from flask import Flask, jsonify
    app = Flask(__name__)

    @app.route('/')
    def home():
        return jsonify({{"message": "Welcome to {app_name}"}})

    @app.route('/ping')
    def ping():
        return jsonify({{"pong": True}})

    if __name__ == '__main__':
        app.run(host='0.0.0.0', port=5000)
    """)
    with open(os.path.join(backend, "app.py"), "w") as f:
        f.write(app_py)
    print("‚úÖ Backend generated")

    # --- –°–±–æ—Ä–∫–∞ ---
    print(f"=== Building targets: {targets} ===")
    if "web" in targets:
        run("npm install -g serve", check=False)
    if "exe" in targets:
        run(f"pyinstaller --onefile {backend}/app.py", check=False)
    if "apk" in targets or "aab" in targets:
        install_flutter()
        run("flutter build apk", check=False)
    if "iso" in targets:
        run(f"genisoimage -o {out_dir}/app.iso -J -r {out_dir}", check=False)
    print("‚úÖ Build complete")


# === MAIN ===
if __name__ == "__main__":
    args = sys.argv[1:]
    out = OUT_DIR
    targets = DEFAULT_BUILD
    ai_flag = "--ai" in args or not os.path.exists("app.yaml")

    install_system_deps()
    install_pip_deps()

    idx = week_index()
    api_key = OPENAI_KEYS[idx]
    print(f"üìÖ Week {datetime.date.today().isocalendar()[1]} ‚Üí selected API key #{idx+1}")

    if ai_flag and api_key:
        ai_generate_yaml(api_key)
    elif not os.path.exists("app.yaml"):
        print("‚ùå No app.yaml found and AI disabled. Exiting.")
        sys.exit(1)

    build_from_yaml("app.yaml", out, targets)
    print("üéØ All done! dist/ ready.")
