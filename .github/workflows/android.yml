name: App Forge CI - Web/APK/AAB Generator

on:
  push:
    branches: ["main"]
    tags: ["v*"]
  workflow_dispatch:
    inputs:
      build_id:
        description: "App Forge Build ID"
        required: true
        type: string

env:
  API: https://riff.new/_projects/brittle-warm-bridge-jr0j/dbtn/devx/app/routes
  TOKEN: ${{ secrets.BUILD_INGEST_TOKEN }}
  BUILD_ID: ${{ github.event.inputs.build_id }}

jobs:
  build-all:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Node.js для веба
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      # Java для Android
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      # Android SDK
      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: "latest"
          packages: |
            platform-tools
            cmdline-tools;latest
            build-tools;34.0.0
            platforms;android-34
          accept-android-sdk-licenses: true

      - name: Show Android SDK
        shell: bash
        run: |
          echo "ANDROID_HOME=${ANDROID_HOME:-unset}"
          echo "ANDROID_SDK_ROOT=${ANDROID_SDK_ROOT:-unset}"
          SDK="${ANDROID_SDK_ROOT:-${ANDROID_HOME:-/usr/local/android-sdk}}"
          echo "Using SDK path: $SDK"
          ls -la "$SDK" || true
          ls -la "$SDK/platforms" || true
          ls -la "$SDK/build-tools" || true

      # Установка зависимостей фронтенда
      - name: Install frontend dependencies
        shell: bash
        run: |
          set -eu -o pipefail
          if [ -f package.json ]; then
            npm ci --prefer-offline --legacy-peer-deps || true
          elif [ -f frontend/package.json ]; then
            (cd frontend && npm ci --prefer-offline --legacy-peer-deps) || true
          else
            echo "No frontend package.json found; skipping npm install"

      # Сборка Web, APK и AAB
      - name: Build Web, APK, AAB
        shell: bash
        run: |
          set -eu -o pipefail
          WEB_OK=0
          APK_OK=0
          AAB_OK=0

          # Web
          echo "=== Building Web ==="
          if [ -f package.json ]; then
            npm run build || WEB_OK=$?
          elif [ -f frontend/package.json ]; then
            (cd frontend && npm run build) || WEB_OK=$?
          else
            echo "No Web project found"
            WEB_OK=2
          fi
          echo "WEB_OK=$WEB_OK" >> $GITHUB_ENV

          # Gradle wrapper
          GRADLEW=./gradlew
          if [ ! -f ./gradlew ]; then
            GRADLEW=$(find . -maxdepth 4 -type f -name gradlew | head -n1 || true)
          fi
          if [ -n "$GRADLEW" ]; then chmod +x "$GRADLEW"; fi

          # APK
          echo "=== Building APK ==="
          if [ -n "$GRADLEW" ]; then
            "$GRADLEW" assembleRelease || APK_OK=$?
          else
            echo "Skipping APK build: gradlew missing"
            APK_OK=3
          fi
          echo "APK_OK=$APK_OK" >> $GITHUB_ENV

          # AAB
          echo "=== Building AAB ==="
          if [ -n "$GRADLEW" ]; then
            "$GRADLEW" bundleRelease || AAB_OK=$?
          else
            echo "Skipping AAB build: gradlew missing"
            AAB_OK=3
          fi
          echo "AAB_OK=$AAB_OK" >> $GITHUB_ENV

      # Подготовка артефактов
      - name: Prepare artifacts
        shell: bash
        run: |
          set -euo pipefail
          WEB_ZIP="web.zip"
          if [ -d dist ]; then
            zip -r "$WEB_ZIP" dist >/dev/null
          elif [ -d build ]; then
            zip -r "$WEB_ZIP" build >/dev/null
          elif [ -d www ]; then
            zip -r "$WEB_ZIP" www >/dev/null
          else
            echo "{}" > empty_web_placeholder.txt
            zip -r "$WEB_ZIP" empty_web_placeholder.txt >/dev/null
          fi
          echo "WEB_ARTIFACT=$WEB_ZIP" >> $GITHUB_ENV

          APK_FILE=$(find . -type f -path "*/build/outputs/apk/*release*/*.apk" | head -n1 || true)
          echo "APK_ARTIFACT=$APK_FILE" >> $GITHUB_ENV

          AAB_FILE=$(find . -type f -path "*/build/outputs/bundle/*[Rr]elease*/*.aab" | head -n1 || true)
          echo "AAB_ARTIFACT=$AAB_FILE" >> $GITHUB_ENV

      # Upload в App Forge с повтором
      - name: Upload to App Forge
        if: ${{ env.TOKEN != '' }}
        shell: bash
        run: |
          set -euo pipefail
          API_URL="$API/ci/ingest/${BUILD_ID}"
          upload() {
            local path="$1"
            local ctype="$2"
            if [ -z "$path" ] || [ ! -f "$path" ]; then
              echo "Skipping missing file $path"
              return 0
            fi
            for i in 1 2 3; do
              curl -S --fail -X POST "$API_URL" \
                -H "X-Filename: $(basename "$path")" \
                -H "X-Content-Type: $ctype" \
                -H "X-Build-Token: $TOKEN" \
                --data-binary @"$path" && return 0 || echo "Attempt $i failed"
              sleep $((i*2))
            done
            echo "⚠️ Upload failed: $path"
          }

          upload "${WEB_ARTIFACT:-web.zip}" "application/zip"
          upload "${APK_ARTIFACT:-}" "application/vnd.android.package-archive"
          upload "${AAB_ARTIFACT:-}" "application/octet-stream"

      # GitHub fallback
      - name: Upload fallback artifacts
        uses: actions/upload-artifact@v4
        with:
          name: appforge-all
          path: |
            ${{ env.WEB_ARTIFACT }}
            ${{ env.APK_ARTIFACT }}
            ${{ env.AAB_ARTIFACT }}
          retention-days: 7

      # Финальный summary
      - name: Summary
        if: always()
        shell: bash
        run: |
          echo "=== SUMMARY ==="
          echo "Build ID: ${BUILD_ID}"
          echo "Web build: ${WEB_OK:-unknown}"
          echo "APK build: ${APK_OK:-unknown}"
          echo "AAB build: ${AAB_OK:-unknown}"
          echo "Artifacts:"
          echo " - WEB: ${WEB_ARTIFACT:-(none)}"
          echo " - APK: ${APK_ARTIFACT:-(none)}"
          echo " - AAB: ${AAB_ARTIFACT:-(none)}"
          exit 0
