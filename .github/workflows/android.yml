name: App Forge CI

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  workflow_dispatch:
    inputs:
      build_id:
        description: "App Forge Build ID"
        required: true
        type: string

env:
  API: https://riff.new/_projects/brittle-warm-bridge-jr0j/dbtn/devx/app/routes
  TOKEN: ${{ secrets.BUILD_INGEST_TOKEN }}
  BUILD_ID: ${{ github.event.inputs.build_id }}

jobs:

  build-web:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"
      - name: Build Web
        shell: bash
        run: |
          set -euo pipefail
          echo "üéØ Building Web..."
          if [ -f package.json ]; then
            npm ci --prefer-offline --legacy-peer-deps
            npm run build
          elif [ -f frontend/package.json ]; then
            (cd frontend && npm ci --prefer-offline --legacy-peer-deps && npm run build)
          else
            echo "‚ö†Ô∏è No package.json found, skipping web build"
      - name: Package Web artifact
        shell: bash
        run: |
          FILE=web.zip
          if [ -d dist ]; then zip -r "$FILE" dist >/dev/null
          elif [ -d build ]; then zip -r "$FILE" build >/dev/null
          elif [ -d www ]; then zip -r "$FILE" www >/dev/null
          else zip -r "$FILE" . >/dev/null; fi
          echo "FILE_PATH=$FILE" >> $GITHUB_ENV
      - name: Upload Web
        if: ${{ env.TOKEN != '' && env.FILE_PATH != '' }}
        shell: bash
        run: |
          echo "üì§ Uploading $FILE_PATH..."
          curl -fsSL -X POST "$API/ci/ingest/${BUILD_ID}" \
            -H "X-Filename: $(basename $FILE_PATH)" \
            -H "X-Content-Type: application/zip" \
            -H "X-Build-Token: $TOKEN" \
            --data-binary @"$FILE_PATH" || echo "‚ö†Ô∏è Upload failed"

  build-apk:
    runs-on: ubuntu-latest
    needs: build-web
    steps:
      - uses: actions/checkout@v4
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: latest
          packages: |
            platform-tools
            build-tools;34.0.0
            platforms;android-34
          accept-android-sdk-licenses: true
      - name: Build APK
        shell: bash
        run: |
          set -euo pipefail
          GRADLEW=./gradlew
          if [ ! -f gradlew ]; then GRADLEW=$(find . -name gradlew | head -n1); fi
          chmod +x "$GRADLEW"
          "$GRADLEW" assembleRelease
      - name: Prepare APK artifact
        shell: bash
        run: |
          FILE=$(find . -type f -path "*/build/outputs/apk/*release*/*.apk" | head -n1)
          echo "FILE_PATH=$FILE" >> $GITHUB_ENV
      - name: Upload APK
        if: ${{ env.TOKEN != '' && env.FILE_PATH != '' }}
        shell: bash
        run: |
          curl -fsSL -X POST "$API/ci/ingest/${BUILD_ID}" \
            -H "X-Filename: $(basename $FILE_PATH)" \
            -H "X-Content-Type: application/vnd.android.package-archive" \
            -H "X-Build-Token: $TOKEN" \
            --data-binary @"$FILE_PATH" || echo "‚ö†Ô∏è Upload failed"

  build-aab:
    runs-on: ubuntu-latest
    needs: build-web
    steps:
      - uses: actions/checkout@v4
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: latest
          packages: |
            platform-tools
            build-tools;34.0.0
            platforms;android-34
          accept-android-sdk-licenses: true
      - name: Build AAB
        shell: bash
        run: |
          set -euo pipefail
          GRADLEW=./gradlew
          if [ ! -f gradlew ]; then GRADLEW=$(find . -name gradlew | head -n1); fi
          chmod +x "$GRADLEW"
          "$GRADLEW" bundleRelease
      - name: Prepare AAB artifact
        shell: bash
        run: |
          FILE=$(find . -type f -path "*/build/outputs/bundle/*release*/*.aab" | head -n1)
          echo "FILE_PATH=$FILE" >> $GITHUB_ENV
      - name: Upload AAB
        if: ${{ env.TOKEN != '' && env.FILE_PATH != '' }}
        shell: bash
        run: |
          curl -fsSL -X POST "$API/ci/ingest/${BUILD_ID}" \
            -H "X-Filename: $(basename $FILE_PATH)" \
            -H "X-Content-Type: application/octet-stream" \
            -H "X-Build-Token: $TOKEN" \
            --data-binary @"$FILE_PATH" || echo "‚ö†Ô∏è Upload failed"
