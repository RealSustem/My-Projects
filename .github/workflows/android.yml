name: App Forge CI

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  workflow_dispatch:
    inputs:
      build_id:
        description: "App Forge Build ID (from App Forge UI)"
        required: false
        type: string

env:
  API: https://riff.new/_projects/brittle-warm-bridge-jr0j/dbtn/devx/app/routes
  TOKEN: ${{ secrets.BUILD_INGEST_TOKEN }}
  BUILD_ID: ${{ github.event.inputs.build_id || secrets.BUILD_ID }}

jobs:

  build-web:
    name: Build Web
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Build Web
        shell: bash
        run: |
          set -euo pipefail
          echo "ðŸŽ¯ Building web..."
          if [ -f package.json ]; then
            npm ci && npm run build
          elif [ -f frontend/package.json ]; then
            (cd frontend && npm ci && npm run build)
          else
            echo "âš ï¸ No package.json found, skipping web build"
          fi

      - name: Prepare Web artifact
        shell: bash
        run: |
          set -euo pipefail
          FILE="web.zip"
          if [ -d dist ]; then zip -r "$FILE" dist >/dev/null
          elif [ -d build ]; then zip -r "$FILE" build >/dev/null
          elif [ -d www ]; then zip -r "$FILE" www >/dev/null
          else zip -r "$FILE" . >/dev/null; fi

          if [ ! -f "$FILE" ]; then
            echo "âš ï¸ Artifact not found, workflow continues"
            echo "FILE_PATH=" >> "$GITHUB_ENV"
          else
            echo "FILE_PATH=$FILE" >> "$GITHUB_ENV"
            echo "âœ… Web artifact ready: $FILE"
          fi

      - name: Upload to App Forge
        if: ${{ env.TOKEN != '' && env.FILE_PATH != '' }}
        shell: bash
        run: |
          echo "ðŸ“¤ Uploading $FILE_PATH to App Forge..."
          curl -fsSL -X POST "$API/ci/ingest/${BUILD_ID}" \
            -H "X-Filename: $(basename "$FILE_PATH")" \
            -H "X-Content-Type: application/zip" \
            -H "X-Build-Token: $TOKEN" \
            --data-binary @"$FILE_PATH"

      - name: Upload Web artifact to GitHub (fallback)
        if: ${{ env.FILE_PATH != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: ${{ env.FILE_PATH }}
          retention-days: 5

  build-apk:
    name: Build APK
    runs-on: ubuntu-latest
    needs: build-web
    strategy:
      matrix:
        target: [apk]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          build-tools: "34.0.0"

      - name: Build APK
        shell: bash
        env:
          TARGET: apk
        run: |
          set -euo pipefail
          GRADLEW="./gradlew"
          if [ ! -f gradlew ]; then GRADLEW=$(find . -name gradlew | head -n1); fi
          chmod +x "$GRADLEW"
          "$GRADLEW" assembleRelease

      - name: Prepare APK artifact
        shell: bash
        run: |
          FILE=$(find . -type f -path "*/build/outputs/apk/*release*/*.apk" | head -n1)
          if [ -z "$FILE" ]; then
            echo "âš ï¸ APK not found"
            echo "FILE_PATH=" >> "$GITHUB_ENV"
          else
            echo "FILE_PATH=$FILE" >> "$GITHUB_ENV"
            echo "âœ… APK ready: $FILE"
          fi

      - name: Upload APK to App Forge
        if: ${{ env.TOKEN != '' && env.FILE_PATH != '' }}
        shell: bash
        run: |
          curl -fsSL -X POST "$API/ci/ingest/${BUILD_ID}" \
            -H "X-Filename: $(basename "$FILE_PATH")" \
            -H "X-Content-Type: application/vnd.android.package-archive" \
            -H "X-Build-Token: $TOKEN" \
            --data-binary @"$FILE_PATH"

      - name: Upload APK artifact to GitHub (fallback)
        if: ${{ env.FILE_PATH != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: apk-build
          path: ${{ env.FILE_PATH }}
          retention-days: 5

  build-aab:
    name: Build AAB
    runs-on: ubuntu-latest
    needs: build-web
    strategy:
      matrix:
        target: [aab]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          build-tools: "34.0.0"

      - name: Build AAB
        shell: bash
        env:
          TARGET: aab
        run: |
          set -euo pipefail
          GRADLEW="./gradlew"
          if [ ! -f gradlew ]; then GRADLEW=$(find . -name gradlew | head -n1); fi
          chmod +x "$GRADLEW"
          "$GRADLEW" bundleRelease

      - name: Prepare AAB artifact
        shell: bash
        run: |
          FILE=$(find . -type f -path "*/build/outputs/bundle/*[Rr]elease*/*.aab" | head -n1)
          if [ -z "$FILE" ]; then
            echo "âš ï¸ AAB not found"
            echo "FILE_PATH=" >> "$GITHUB_ENV"
          else
            echo "FILE_PATH=$FILE" >> "$GITHUB_ENV"
            echo "âœ… AAB ready: $FILE"
          fi

      - name: Upload AAB to App Forge
        if: ${{ env.TOKEN != '' && env.FILE_PATH != '' }}
        shell: bash
        run: |
          curl -fsSL -X POST "$API/ci/ingest/${BUILD_ID}" \
            -H "X-Filename: $(basename "$FILE_PATH")" \
            -H "X-Content-Type: application/octet-stream" \
            -H "X-Build-Token: $TOKEN" \
            --data-binary @"$FILE_PATH"

      - name: Upload AAB artifact to GitHub (fallback)
        if: ${{ env.FILE_PATH != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: aab-build
          path: ${{ env.FILE_PATH }}
          retention-days: 5
