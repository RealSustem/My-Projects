name: App Forge CI

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  workflow_dispatch:
    inputs:
      build_id:
        description: "App Forge Build ID (from App Forge UI)"
        required: true
        type: string

env:
  BUILD_ID: ${{ github.event.inputs.build_id || vars.REPO_VAR_BUILD_ID }}
  API: https://riff.new/_projects/brittle-warm-bridge-jr0j/dbtn/devx/app/routes

# ------------------------------------------------------------------
# JOB: build_apk
# ------------------------------------------------------------------
jobs:
  build_apk:
    runs-on: ubuntu-latest
    env:
      TOKEN: ${{ secrets.BUILD_INGEST_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare runner (install utils)
        run: |
          sudo apt-get update -y
          # tar, unzip, wget, curl, zip â€” Ð²ÑÑ‘ ÑÑ‚Ð°Ð²Ð¸Ð¼ ÑÑ€Ð°Ð·Ñƒ
          sudo apt-get install -y tar unzip wget curl zip lib32stdc++6 lib32z1

      - name: Set up Java (for Gradle)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Install Android SDK (manual, stable)
        shell: bash
        run: |
          set -eux
          export ANDROID_HOME=/usr/local/lib/android/sdk
          sudo mkdir -p $ANDROID_HOME
          sudo chown -R $USER:$USER $ANDROID_HOME
          mkdir -p $ANDROID_HOME/cmdline-tools
          cd $ANDROID_HOME/cmdline-tools
          # Ñ„Ð¸ÐºÑÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ commandlinetools (Ñ€Ð°Ð±Ð¾Ñ‡Ð°Ñ)
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O cmdline-tools.zip
          unzip -q cmdline-tools.zip
          # Ð² zip Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾ Ð¿Ð°Ð¿ÐºÐ° cmdline-tools, Ð¿ÐµÑ€ÐµÐ¼ÐµÑ‰Ð°ÐµÐ¼ Ð² latest
          mv cmdline-tools latest || true
          # Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð² PATH ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾ (Ñ‡ÐµÑ€ÐµÐ· GITHUB_ENV Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ð¹ PATH)
          echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
          echo "PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH" >> $GITHUB_ENV
          # ÑÐ¾Ð³Ð»Ð°ÑˆÐ°ÐµÐ¼ÑÑ Ñ Ð»Ð¸Ñ†ÐµÐ½Ð·Ð¸ÑÐ¼Ð¸ Ð¸ ÑÑ‚Ð°Ð²Ð¸Ð¼ Ð½ÑƒÐ¶Ð½Ñ‹Ðµ Ð¿Ð°ÐºÐµÑ‚Ñ‹
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --sdk_root=${ANDROID_HOME} --licenses >/dev/null || true
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --sdk_root=${ANDROID_HOME} \
            "platform-tools" \
            "platforms;android-34" \
            "build-tools;34.0.0" >/dev/null || true
          echo "Android SDK installed"


      - name: Install Gradle (fallback) # ðŸ‘‡ Added
        if: ${{ !exists('gradlew') }}
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: 8.7

      - name: Verify sdk + tools
        run: |
          echo "ANDROID_HOME=$ANDROID_HOME"
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --list | head -n 40 || true
          which tar || true
          tar --version || true
          adb --version || true

      - name: Build APK (Gradle)
        shell: bash
        run: |
          set -euo pipefail
          shopt -s globstar
          if [ -f gradlew ] || ls -1 **/gradlew 2>/dev/null | grep -q .; then
            GRADLEW="$(ls -1 **/gradlew 2>/dev/null | head -n1)"
            [ -z "$GRADLEW" ] && GRADLEW=./gradlew
            chmod +x "$GRADLEW"
            "$GRADLEW" assembleRelease
          else
            echo "gradlew not found; skipping APK build"
            exit 0
          fi

      - name: Upload APK to App Forge (skip if no token)
        if: ${{ env.TOKEN != '' }}
        shell: bash
        run: |
          set -euo pipefail
          shopt -s globstar
          APK="$(ls -1 **/build/outputs/apk/*release*/**/*.apk **/build/outputs/apk/release/*.apk 2>/dev/null | head -n1 || true)"
          if [ -z "$APK" ]; then
            echo "APK not found; skipping upload"
            exit 0
          fi
          echo "Uploading $APK"
          curl -sS -X POST "$API/ci/ingest/$BUILD_ID" \
            -H "X-Filename: $(basename "$APK")" \
            -H "X-Content-Type: application/vnd.android.package-archive" \
            -H "X-Build-Token: $TOKEN" \
            --data-binary @"$APK"

  # ------------------------------------------------------------------
  # JOB: build_aab
  # ------------------------------------------------------------------
  build_aab:
    runs-on: ubuntu-latest
    env:
      TOKEN: ${{ secrets.BUILD_INGEST_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare runner (install utils)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y tar unzip wget curl zip lib32stdc++6 lib32z1

      - name: Set up Java (for Gradle)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Install Android SDK (manual, stable)
        shell: bash
        run: |
          set -eux
          export ANDROID_HOME=/usr/local/lib/android/sdk
          sudo mkdir -p $ANDROID_HOME
          sudo chown -R $USER:$USER $ANDROID_HOME
          mkdir -p $ANDROID_HOME/cmdline-tools
          cd $ANDROID_HOME/cmdline-tools
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O cmdline-tools.zip
          unzip -q cmdline-tools.zip
          mv cmdline-tools latest || true
          echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
          echo "PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH" >> $GITHUB_ENV
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --sdk_root=${ANDROID_HOME} --licenses >/dev/null || true
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --sdk_root=${ANDROID_HOME} \
            "platform-tools" \
            "platforms;android-34" \
            "build-tools;34.0.0" >/dev/null || true
          echo "Android SDK installed"

      - name: Build AAB (Gradle)
        shell: bash
        run: |
          set -euo pipefail
          shopt -s globstar
          if [ -f gradlew ] || ls -1 **/gradlew 2>/dev/null | grep -q .; then
            GRADLEW="$(ls -1 **/gradlew 2>/dev/null | head -n1)"
            [ -z "$GRADLEW" ] && GRADLEW=./gradlew
            chmod +x "$GRADLEW"
            "$GRADLEW" bundleRelease
          else
            echo "gradlew not found; skipping AAB build"
            exit 0
          fi

      - name: Upload AAB to App Forge (skip if no token)
        if: ${{ env.TOKEN != '' }}
        shell: bash
        run: |
          set -euo pipefail
          shopt -s globstar
          AAB="$(ls -1 **/build/outputs/bundle/*[Rr]elease*/**/*.aab **/build/outputs/bundle/release/*.aab 2>/dev/null | head -n1 || true)"
          if [ -z "$AAB" ]; then
            echo "AAB not found; skipping upload"
            exit 0
          fi
          echo "Uploading $AAB"
          curl -sS -X POST "$API/ci/ingest/$BUILD_ID" \
            -H "X-Filename: $(basename "$AAB")" \
            -H "X-Content-Type: application/octet-stream" \
            -H "X-Build-Token: $TOKEN" \
            --data-binary @"$AAB"

  # ------------------------------------------------------------------
  # JOB: build_web
  # ------------------------------------------------------------------
  build_web:
    runs-on: ubuntu-latest
    env:
      TOKEN: ${{ secrets.BUILD_INGEST_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare runner (install utils)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y tar unzip wget curl zip

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install web deps
        shell: bash
        run: |
          set -euo pipefail
          if [ -f package.json ]; then
            npm ci
          elif [ -f frontend/package.json ]; then
            (cd frontend && npm ci)
          else
            echo "No package.json found; skipping npm install"
          fi

      - name: Build web
        shell: bash
        run: |
          set -euo pipefail
          if [ -f package.json ]; then
            npm run build
          elif [ -f frontend/package.json ]; then
            (cd frontend && npm run build)
          else
            echo "No package.json found; skipping web build"
          fi

      - name: Upload web to App Forge (skip if no token)
        if: ${{ env.TOKEN != '' }}
        shell: bash
        run: |
          set -euo pipefail
          ZIP=web.zip
          if [ -d dist ]; then zip -r "$ZIP" dist >/dev/null
          elif [ -d build ]; then zip -r "$ZIP" build >/dev/null
          elif [ -d www ]; then zip -r "$ZIP" www >/dev/null
          else zip -r "$ZIP" . >/dev/null
          fi
          curl -sS -X POST "$API/ci/ingest/$BUILD_ID" \
            -H "X-Filename: $ZIP" \
            -H "X-Content-Type: application/zip" \
            -H "X-Build-Token: $TOKEN" \
            --data-binary @"$ZIP"
