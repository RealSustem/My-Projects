name: App Forge CI

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  workflow_dispatch:
    inputs:
      build_id:
        description: "App Forge Build ID (from App Forge UI)"
        required: false
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    strategy:
      matrix:
        target: [apk, aab, web]

    env:
      API: https://riff.new/_projects/brittle-warm-bridge-jr0j/dbtn/devx/app/routes
      TOKEN: ${{ secrets.BUILD_INGEST_TOKEN }}
      BUILD_ID: ${{ github.event.inputs.build_id || secrets.BUILD_ID }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Debug variables
        run: |
          echo "TOKEN length: ${#TOKEN:-0}"
          echo "BUILD_ID: ${BUILD_ID:-unset}"
          echo "TARGET: ${{ matrix.target }}"

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Android SDK
        if: ${{ matrix.target != 'web' }}
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          build-tools: "34.0.0"

      - name: Build project
        shell: bash
        env:
          TARGET: ${{ matrix.target }}
        run: |
          set -euo pipefail
          echo "üéØ Building target: $TARGET"

          GRADLEW=""
          if [ -f gradlew ]; then
            GRADLEW="./gradlew"
          else
            GRADLEW=$(find . -name gradlew | head -n1 || true)
          fi

          if [ -n "$GRADLEW" ]; then
            chmod +x "$GRADLEW"
            case "$TARGET" in
              apk) "$GRADLEW" assembleRelease ;;
              aab) "$GRADLEW" bundleRelease ;;
              web)
                if [ -f package.json ]; then npm ci && npm run build;
                elif [ -f frontend/package.json ]; then (cd frontend && npm ci && npm run build);
                else echo "‚ö†Ô∏è No package.json found; skipping web build"; fi
                ;;
              *) echo "‚ùå Unknown target: $TARGET"; exit 1 ;;
            esac
          elif [ "$TARGET" = "web" ]; then
            if [ -f package.json ]; then npm ci && npm run build;
            elif [ -f frontend/package.json ]; then (cd frontend && npm ci && npm run build);
            else echo "‚ö†Ô∏è No package.json found; skipping web build"; fi
          fi

      - name: Prepare artifact
        id: artifact
        shell: bash
        env:
          TARGET: ${{ matrix.target }}
        run: |
          set -euo pipefail
          case "$TARGET" in
            apk)
              FILE=$(find . -type f -path "*/build/outputs/apk/*release*/*.apk" | head -n1 || true)
              ;;
            aab)
              FILE=$(find . -type f -path "*/build/outputs/bundle/*[Rr]elease*/*.aab" | head -n1 || true)
              ;;
            web)
              FILE="web.zip"
              if [ -d dist ]; then zip -r "$FILE" dist >/dev/null;
              elif [ -d build ]; then zip -r "$FILE" build >/dev/null;
              elif [ -d www ]; then zip -r "$FILE" www >/dev/null;
              else zip -r "$FILE" . >/dev/null; fi
              ;;
          esac

          if [ -z "${FILE:-}" ] || [ ! -f "$FILE" ]; then
            echo "‚ùå Artifact not found"; exit 2
          fi
          echo "FILE_PATH=$FILE" >> "$GITHUB_ENV"
          echo "‚úÖ Artifact ready: $FILE"

      - name: Upload to App Forge
        if: ${{ env.TOKEN != '' }}
        shell: bash
        run: |
          set -euo pipefail
          echo "üì§ Uploading $FILE_PATH to App Forge..."
          CONTENT_TYPE="application/octet-stream"
          [[ "$TARGET" == "apk" ]] && CONTENT_TYPE="application/vnd.android.package-archive"
          [[ "$TARGET" == "web" ]] && CONTENT_TYPE="application/zip"

          curl -fsSL -X POST "$API/ci/ingest/${BUILD_ID}" \
            -H "X-Filename: $(basename "$FILE_PATH")" \
            -H "X-Content-Type: $CONTENT_TYPE" \
            -H "X-Build-Token: $TOKEN" \
            --data-binary @"$FILE_PATH"

      - name: Upload artifact to GitHub (fallback)
        if: ${{ env.TOKEN == '' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.target }}-build
          path: ${{ env.FILE_PATH }}
          retention-days: 5

      - name: Update success status
        if: ${{ success() && env.TOKEN != '' }}
        shell: bash
        run: |
          curl -fsSL -X POST "$API/ci/update/${BUILD_ID}" \
            -H 'Content-Type: application/json' \
            -H "X-Build-Token: $TOKEN" \
            -d '{"status":"success","progress":100}'

      - name: Update failed status
        if: ${{ failure() && env.TOKEN != '' }}
        shell: bash
        run: |
          curl -fsSL -X POST "$API/ci/update/${BUILD_ID}" \
            -H 'Content-Type: application/json' \
            -H "X-Build-Token: $TOKEN" \
            -d '{"status":"failed","progress":0,"logs":["failed on GitHub Actions"]}'

      - name: Final summary
        if: always()
        shell: bash
        run: |
          echo "üèÅ Build finished for $TARGET"
          if [ -z "${TOKEN:-}" ]; then
            echo "‚ö†Ô∏è App Forge upload skipped ‚Äî missing token. Artifact available in GitHub Artifacts."
          else
            echo "‚úÖ Build uploaded to App Forge successfully."
