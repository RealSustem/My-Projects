name: App Forge CI

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  workflow_dispatch:
    inputs:
      build_id:
        description: "App Forge Build ID (from App Forge UI)"
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    strategy:
      matrix:
        target: [apk, aab, web]

    env:
      BUILD_ID: ${{ github.event.inputs.build_id || vars.REPO_VAR_BUILD_ID }}
      TARGET: ${{ matrix.target }}
      API: https://riff.new/_projects/brittle-warm-bridge-jr0j/dbtn/devx/app/routes
      TOKEN: ${{ secrets.BUILD_INGEST_TOKEN }}
      ANDROID_HOME: /usr/local/lib/android/sdk
      PATH: /usr/local/lib/android/sdk/cmdline-tools/latest/bin:/usr/local/lib/android/sdk/platform-tools:/usr/local/lib/android/sdk/build-tools/34.0.0:$PATH

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare system (install tar, zip, wget, unzip, node, etc.)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y tar zip unzip wget curl lib32stdc++6 lib32z1

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Install Node.js (for web)
        if: ${{ matrix.target == 'web' }}
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Manually install Android SDK
        if: ${{ matrix.target != 'web' }}
        run: |
          set -eux
          mkdir -p $ANDROID_HOME/cmdline-tools
          cd $ANDROID_HOME/cmdline-tools
          echo "ðŸ“¦ Downloading Android command line tools..."
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O cmdline-tools.zip
          unzip -q cmdline-tools.zip
          mv cmdline-tools latest
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses >/dev/null
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager \
            "platform-tools" \
            "platforms;android-34" \
            "build-tools;34.0.0" \
            "tools" >/dev/null
          echo "âœ… Android SDK installed successfully"

      - name: Install dependencies
        run: |
          set -e
          echo "Installing dependencies for target: $TARGET"
          if [ -f gradlew ] || [ -n "$(ls -1 **/gradlew 2>/dev/null || true)" ]; then
            GRADLEW="$(ls -1 **/gradlew 2>/dev/null | head -n1)"
            [ -z "$GRADLEW" ] && GRADLEW=./gradlew
            chmod +x "$GRADLEW"
            "$GRADLEW" dependencies || true
          elif [ -f package.json ]; then
            npm ci || npm install
          elif [ -f frontend/package.json ]; then
            (cd frontend && npm ci || npm install)
          fi

      - name: Build project
        run: |
          set -e
          echo "ðŸš€ Building target: $TARGET"
          if [ -f gradlew ] || [ -n "$(ls -1 **/gradlew 2>/dev/null || true)" ]; then
            GRADLEW="$(ls -1 **/gradlew 2>/dev/null | head -n1)"
            [ -z "$GRADLEW" ] && GRADLEW=./gradlew
            chmod +x "$GRADLEW"
            case "$TARGET" in
              apk) "$GRADLEW" assembleRelease ;;
              aab) "$GRADLEW" bundleRelease ;;
              *) echo "Unknown gradle target: $TARGET" ;;
            esac
          elif [ "$TARGET" = "web" ]; then
            if [ -f package.json ]; then
              npm run build
            elif [ -f frontend/package.json ]; then
              (cd frontend && npm run build)
            fi
          fi

      - name: Upload artifact to App Forge
        if: ${{ env.TOKEN != '' }}
        run: |
          set -e
          echo "ðŸ“¤ Uploading build for $TARGET"
          case "$TARGET" in
            apk)
              APK="$(ls -1 **/build/outputs/apk/*release*/**/*.apk **/build/outputs/apk/release/*.apk 2>/dev/null | head -n1)"
              [ -z "$APK" ] && { echo "âŒ APK not found"; exit 2; }
              curl -sS -X POST "$API/ci/ingest/$BUILD_ID" \
                -H "X-Filename: $(basename "$APK")" \
                -H "X-Content-Type: application/vnd.android.package-archive" \
                -H "X-Build-Token: $TOKEN" \
                --data-binary @"$APK"
              ;;
            aab)
              AAB="$(ls -1 **/build/outputs/bundle/*[Rr]elease*/**/*.aab **/build/outputs/bundle/release/*.aab 2>/dev/null | head -n1)"
              [ -z "$AAB" ] && { echo "âŒ AAB not found"; exit 2; }
              curl -sS -X POST "$API/ci/ingest/$BUILD_ID" \
                -H "X-Filename: $(basename "$AAB")" \
                -H "X-Content-Type: application/octet-stream" \
                -H "X-Build-Token: $TOKEN" \
                --data-binary @"$AAB"
              ;;
            web)
              ZIP=web.zip
              if [ -d dist ]; then
                zip -r "$ZIP" dist >/dev/null
              elif [ -d build ]; then
                zip -r "$ZIP" build >/dev/null
              elif [ -d www ]; then
                zip -r "$ZIP" www >/dev/null
              else
                zip -r "$ZIP" . >/dev/null
              fi
              curl -sS -X POST "$API/ci/ingest/$BUILD_ID" \
                -H "X-Filename: $ZIP" \
                -H "X-Content-Type: application/zip" \
                -H "X-Build-Token: $TOKEN" \
                --data-binary @"$ZIP"
              ;;
          esac

      - name: Update success status
        if: ${{ success() && env.TOKEN != '' }}
        run: |
          curl -sS -X POST "$API/ci/update/${BUILD_ID}" \
            -H 'Content-Type: application/json' \
            -H "X-Build-Token: $TOKEN" \
            -d '{"status":"success","progress":100}'

      - name: Update failed status
        if: ${{ failure() && env.TOKEN != '' }}
        run: |
          curl -sS -X POST "$API/ci/update/${BUILD_ID}" \
            -H 'Content-Type: application/json' \
            -H "X-Build-Token: $TOKEN" \
            -d '{"status":"failed","progress":0,"logs":["failed on github actions"]}'
