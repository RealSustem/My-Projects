name: App Forge CI

on:
  push:
    branches: ["main"]
    tags: ["v*"]
  workflow_dispatch:
    inputs:
      build_id:
        description: "App Forge Build ID (from App Forge UI)"
        required: false
        type: string

env:
  API: https://riff.new/_projects/brittle-warm-bridge-jr0j/dbtn/devx/app/routes
  TOKEN: ${{ secrets.BUILD_INGEST_TOKEN }}
  BUILD_ID: ${{ github.event.inputs.build_id || secrets.BUILD_ID }}

jobs:
  build-all:
    name: Build Web + APK + AAB
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Build Web
        shell: bash
        run: |
          set -euo pipefail
          if [ -f package.json ]; then
            npm ci --prefer-offline --legacy-peer-deps
            npm run build
          elif [ -f frontend/package.json ]; then
            (cd frontend && npm ci --prefer-offline --legacy-peer-deps && npm run build)
          else
            echo "‚ö†Ô∏è No package.json found, skipping web build"
          fi

      - name: Prepare Web artifact
        shell: bash
        run: |
          set -euo pipefail
          FILE="web.zip"
          if [ -d dist ]; then
            zip -r "$FILE" dist >/dev/null
          elif [ -d build ]; then
            zip -r "$FILE" build >/dev/null
          elif [ -d www ]; then
            zip -r "$FILE" www >/dev/null
          else
            zip -r "$FILE" . >/dev/null
          fi

          if [ -f "$FILE" ]; then
            echo "FILE_PATH=$FILE" >> "$GITHUB_ENV"
          else
            echo "FILE_PATH=" >> "$GITHUB_ENV"
          fi

      - name: Upload Web to App Forge
        if: ${{ env.TOKEN != '' && env.FILE_PATH != '' }}
        shell: bash
        run: |
          set -euo pipefail
          echo "üì§ Uploading $FILE_PATH to App Forge..."
          curl -fsSL -X POST "$API/ci/ingest/${BUILD_ID}" \
            -H "X-Filename: $(basename "$FILE_PATH")" \
            -H "X-Content-Type: application/zip" \
            -H "X-Build-Token: $TOKEN" \
            --data-binary @"$FILE_PATH" || echo "‚ö†Ô∏è Web upload failed"

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: "latest"
          packages: |
            platform-tools
            cmdline-tools;latest
            build-tools;33.0.2
            platforms;android-33
          accept-android-sdk-licenses: true

      - name: Build APK
        shell: bash
        run: |
          set -euo pipefail
          GRADLEW="./gradlew"
          if [ ! -f gradlew ]; then
            GRADLEW=$(find . -name gradlew | head -n1)
          fi
          chmod +x "$GRADLEW"
          "$GRADLEW" assembleRelease
          FILE=$(find . -type f -path "*/build/outputs/apk/*release*/*.apk" | head -n1)
          if [ -f "$FILE" ]; then
            echo "FILE_PATH=$FILE" >> "$GITHUB_ENV"
          else
            echo "FILE_PATH=" >> "$GITHUB_ENV"
          fi

      - name: Upload APK to App Forge
        if: ${{ env.TOKEN != '' && env.FILE_PATH != '' }}
        shell: bash
        run: |
          set -euo pipefail
          echo "üì§ Uploading APK $FILE_PATH..."
          curl -fsSL -X POST "$API/ci/ingest/${BUILD_ID}" \
            -H "X-Filename: $(basename "$FILE_PATH")" \
            -H "X-Content-Type: application/vnd.android.package-archive" \
            -H "X-Build-Token: $TOKEN" \
            --data-binary @"$FILE_PATH" || echo "‚ö†Ô∏è APK upload failed"

      - name: Build AAB
        shell: bash
        run: |
          set -euo pipefail
          GRADLEW="./gradlew"
          if [ ! -f gradlew ]; then
            GRADLEW=$(find . -name gradlew | head -n1)
          fi
          chmod +x "$GRADLEW"
          "$GRADLEW" bundleRelease
          FILE=$(find . -type f -path "*/build/outputs/bundle/*[Rr]elease*/*.aab" | head -n1)
          if [ -f "$FILE" ]; then
            echo "FILE_PATH=$FILE" >> "$GITHUB_ENV"
          else
            echo "FILE_PATH=" >> "$GITHUB_ENV"
          fi

      - name: Upload AAB to App Forge
        if: ${{ env.TOKEN != '' && env.FILE_PATH != '' }}
        shell: bash
        run: |
          set -euo pipefail
          echo "üì§ Uploading AAB $FILE_PATH..."
          curl -fsSL -X POST "$API/ci/ingest/${BUILD_ID}" \
            -H "X-Filename: $(basename "$FILE_PATH")" \
            -H "X-Content-Type: application/octet-stream" \
            -H "X-Build-Token: $TOKEN" \
            --data-binary @"$FILE_PATH" || echo "‚ö†Ô∏è AAB upload failed"

      - name: Upload all artifacts to GitHub
        uses: actions/upload-artifact@v4
        with:
          name: all-builds
          path: |
            web.zip
            $(find . -type f -path "*/build/outputs/apk/*release*/*.apk" | head -n1)
            $(find . -type f -path "*/build/outputs/bundle/*[Rr]elease*/*.aab" | head -n1)
          retention-days: 5
